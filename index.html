<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<title>Harta Cadastrală - Afișare Publică</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
body { margin:0; font-family:'Roboto',sans-serif; display:flex; height:100vh; overflow:hidden; }
#sidebar { width:320px; background:#f7f7f7; display:flex; flex-direction:column; border-right:1px solid #ccc; z-index:900; }
#sidebar h2 { margin:10px; font-size:18px; text-align:center; }
#search-section { padding:10px; }
#search-section input { width:100%; margin-bottom:8px; padding:6px; border:1px solid #ccc; border-radius:4px; }
#search-section button { width:100%; margin-top:5px; padding:8px; border:none; border-radius:4px; background:#3f72af; color:white; cursor:pointer; }
#search-section button:hover { background:#2f5597; }
#results { flex:1; overflow:auto; border-top:1px solid #ddd; border-bottom:1px solid #ddd; padding:5px 10px; font-size:14px; }
.result-item { padding:6px; margin-bottom:4px; border-radius:4px; cursor:pointer; background:#fff; border:1px solid #ccc; }
.result-item:hover { background:#e8f0fe; }
.result-item.selected { background:#cfe2ff; border-color:#4a90e2; }
#layers-control { padding:10px; border-top:1px solid #ccc; font-size:14px; }
#map { flex:1; position:relative; }
#legend { position:absolute; bottom:20px; left:20px; background:white; padding:8px 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); font-size:13px; line-height:1.4; z-index:800; }
#details-panel { width:0; transition:width 0.35s ease, opacity 0.35s ease; background:rgba(255,255,255,0.98); overflow:auto; box-shadow:-3px 0 8px rgba(0,0,0,0.3); padding:15px; z-index:1001; position:absolute; top:0; right:0; height:100%; opacity:0; border-left:1px solid #ccc; }
#details-panel.open { width:36%; opacity:1; }
#details-panel button { background:#d9534f; color:white; border:none; border-radius:4px; padding:4px 8px; float:right; cursor:pointer; }
#overlay { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.18); z-index:1000; }
@media (max-width:1000px){ #details-panel.open { width: 50%; } }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Căutare Imobile</h2>
  <div id="search-section">
    <input id="idimobil" placeholder="ID Imobil">
    <input id="proprietar" placeholder="Proprietar">
    <input id="act" placeholder="Act de proprietate">
    <button onclick="search()">Caută</button>
    <button onclick="resetSearch()">Resetează</button>
    <div style="margin-top:6px;font-size:13px;color:#555;">Rezultate: <span id="count">0</span></div>
  </div>
  <div id="results"></div>
  <div id="layers-control">
    <b>Layere</b><br>
    <label><input type="checkbox" id="chkUAT" checked> UAT</label><br>
    <label><input type="checkbox" id="chkIntravilan" checked> Intravilan</label><br>
    <label><input type="checkbox" id="chkTerenuri" checked> Terenuri</label><br>
    <label><input type="checkbox" id="chkConstructii" checked> Construcții</label><br><br>
    <b>Basemap</b><br>
    <select id="basemapSelect" onchange="changeBasemap()">
      <option value="osm">OpenStreetMap</option>
      <option value="esri">ESRI World Imagery</option>
    </select>
  </div>
</div>

<div id="map"></div>

<div id="overlay" onclick="closeDetails()"></div>

<div id="details-panel">
  <button onclick="closeDetails()">X</button>
  <div id="details-content"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ========== Init map & basemaps ========== */
const map = L.map('map',{zoomControl:true}).setView([45.9,25.0],7);

const baseLayers = {
  osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}),
  esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19})
};
baseLayers.osm.addTo(map);

function changeBasemap(){
  const v = document.getElementById('basemapSelect').value;
  for(const k in baseLayers) map.removeLayer(baseLayers[k]);
  baseLayers[v].addTo(map);
}

/* ========== Layers placeholders ========== */
let uatLayer, intravilanLayer, terenuriLayer, constructiiLayer;
const highlightLayer = L.geoJSON(null, { style: { color:'#007bff', weight:2, fillOpacity:0.25 } }).addTo(map);
const selectedLayer = L.geoJSON(null, { style: { color:'#ffcc00', weight:3, fillOpacity:0.45 } }).addTo(map);

/* ========== Load GeoJSONs ========== */
fetch('uat.geojson').then(r=>r.json()).then(data=>{
  uatLayer = L.geoJSON(data, {
    style: { color:'#d32f2f', weight:2, fillOpacity:0 },
    onEachFeature: (f,l)=> l.bindTooltip(f.properties.DEN_UAT)
  }).addTo(map);
  map.fitBounds(uatLayer.getBounds());
});

fetch('intravilan.geojson').then(r=>r.json()).then(data=>{
  intravilanLayer = L.geoJSON(data, {
    style: { color:'#d81b60', weight:1.5, fillOpacity:0.12 },
    onEachFeature: (f,l)=> l.bindTooltip(f.properties.DEN_LOC)
  }).addTo(map);
});

fetch('terenuri.geojson').then(r=>r.json()).then(data=>{
  terenuriLayer = L.geoJSON(data, {
    style: ()=> ({ color:'white', weight:1, fillColor:'blue', fillOpacity:0.2 }),
    onEachFeature: (f,l)=>{
      const p = f.properties;
      const popupHtml = `<b>ImobilID:</b> ${p.ImobilID || ''}<br>
                         <b>Suprafață:</b> ${p.Suprafata || ''}<br>
                         <b>Proprietari:</b> ${p.Proprietari || ''}<br>
                         <b>Acte:</b> ${p.Acte || ''}<br>
                         <a href="#" onclick="openDetails('${p.ImobilID}');event.stopPropagation();">Detalii</a>`;
      l.bindPopup(popupHtml);
      l.on('click', ()=> {
        selectFeatureByFeature(f);
        l.openPopup(); // reapare popup-ul și când e în lista de rezultate
      });
    }
  }).addTo(map);
});

fetch('constructii.geojson').then(r=>r.json()).then(data=>{
  constructiiLayer = L.geoJSON(data, {
    style: ()=> ({ color:'blue', weight:1.5, fillOpacity:0.45 }),
    onEachFeature: (f,l)=>{
      const p=f.properties;
      const popupHtml = `<b>Număr:</b> ${p.Numar || ''}<br>
                         <b>Tip:</b> ${p.Tip || ''}<br>
                         <b>Destinație:</b> ${p.Destinatie || ''}<br>
                         <b>Suprafață:</b> ${p.Suprafata || ''}<br>
                         <b>Proprietari:</b> ${p.Proprietari || ''}<br>
                         <b>Acte:</b> ${p.Acte || ''}`;
      l.bindPopup(popupHtml);
      l.on('click', ()=> {
        selectFeatureByFeature(f);
        l.openPopup();
      });
    }
  }).addTo(map);
});

/* ========== Legendă actualizată ========== */
const legend = L.control({ position:'bottomleft' });
legend.onAdd = ()=> {
  const d = L.DomUtil.create('div','info legend'); d.id='legend';
  d.innerHTML = `
    <div><b>Legendă</b></div>
    <div><span style="display:inline-block;width:18px;height:10px;background:#d32f2f;margin-right:6px"></span> UAT</div>
    <div><span style="display:inline-block;width:18px;height:10px;background:#d81b60;margin-right:6px"></span> Intravilan</div>
    <div><span style="display:inline-block;width:18px;height:10px;background:blue;margin-right:6px"></span> Terenuri</div>
    <div><span style="display:inline-block;width:18px;height:10px;background:blue;margin-right:6px;opacity:0.8"></span> Construcții</div>
  `;
  return d;
};
legend.addTo(map);

/* ========== Toggle layere ========== */
function toggleLayer(layer, checkboxId){
  if(!layer) return;
  const checked = document.getElementById(checkboxId).checked;
  if(checked) map.addLayer(layer); else map.removeLayer(layer);
}
document.getElementById('chkUAT').onchange = ()=> toggleLayer(uatLayer,'chkUAT');
document.getElementById('chkIntravilan').onchange = ()=> toggleLayer(intravilanLayer,'chkIntravilan');
document.getElementById('chkTerenuri').onchange = ()=> toggleLayer(terenuriLayer,'chkTerenuri');
document.getElementById('chkConstructii').onchange = ()=> toggleLayer(constructiiLayer,'chkConstructii');

/* ========== Find feature by ImobilID ========== */
function findFeatureByImobilID(id){
  if(!id) return null;
  let found = null;
  const tryFind = (layer) => {
    if(!layer) return;
    layer.eachLayer(l => {
      const p = l.feature && l.feature.properties;
      if(p && (String(p.ImobilID) === String(id))){
        found = { feature: l.feature, layer: l };
      }
    });
  };
  tryFind(terenuriLayer);
  if(!found) tryFind(constructiiLayer);
  return found;
}

/* ========== Search ========== */
function search(){
  const id = (document.getElementById('idimobil').value || '').toLowerCase();
  const prop = (document.getElementById('proprietar').value || '').toLowerCase();
  const act = (document.getElementById('act').value || '').toLowerCase();

  highlightLayer.clearLayers();
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';
  const matchedFeatures = [];

  if(terenuriLayer){
    terenuriLayer.eachLayer(l => {
      const p = l.feature.properties || {};
      if((!id || (p.ImobilID && String(p.ImobilID).toLowerCase().includes(id))) &&
         (!prop || (p.Proprietari && String(p.Proprietari).toLowerCase().includes(prop))) &&
         (!act || (p.Acte && String(p.Acte).toLowerCase().includes(act)))) {
        matchedFeatures.push(l.feature);
      }
    });
  }

  if(matchedFeatures.length) highlightLayer.addData(matchedFeatures);
  document.getElementById('count').textContent = matchedFeatures.length;

  matchedFeatures.forEach(f => {
    const p = f.properties || {};
    const div = document.createElement('div');
    div.className = 'result-item';
    div.innerHTML = `<b>ID:</b> ${p.ImobilID || ''}<br>
                     <b>Proprietar:</b> ${p.Proprietari || ''}<br>
                     <b>Act:</b> ${p.Acte || ''}<br>
                     <a href="#" onclick="openDetails('${p.ImobilID}'); event.stopPropagation();">Detalii</a>`;
    div.onclick = () => {
      document.querySelectorAll('.result-item').forEach(el=>el.classList.remove('selected'));
      div.classList.add('selected');
      selectFeatureByFeature(f, true);
      const found = findFeatureByImobilID(p.ImobilID);
      if(found && found.layer) found.layer.openPopup(); // popup reapare
    };
    resultsDiv.appendChild(div);
  });
}

function resetSearch(){
  document.getElementById('idimobil').value = '';
  document.getElementById('proprietar').value = '';
  document.getElementById('act').value = '';
  document.getElementById('results').innerHTML = '';
  document.getElementById('count').textContent = '0';
  highlightLayer.clearLayers();
  selectedLayer.clearLayers();
}

/* ========== Select feature (fără zoom automat la detalii) ========== */
function selectFeatureByFeature(feature){
  selectedLayer.clearLayers();
  selectedLayer.addData(feature);
  const bounds = L.geoJSON(feature).getBounds();
  map.panTo(bounds.getCenter(), { animate:true });
}

/* ========== Deschidere detalii (fără zoom automat) ========== */
function openDetails(imobilID){
  const found = findFeatureByImobilID(imobilID);
  fetch(`HTML/${imobilID}.html`).then(r=>r.ok? r.text():'').then(html=>{
    document.getElementById('details-content').innerHTML = html || `<p>Detalii indisponibile pentru ${imobilID}</p>`;
    document.getElementById('details-panel').classList.add('open');
    document.getElementById('overlay').style.display = 'block';

    if(found){
      selectedLayer.clearLayers(); selectedLayer.addData(found.feature);
      const bounds = L.geoJSON(found.feature).getBounds();
      map.panTo(bounds.getCenter(), { animate:true }); // doar pan, fără zoom
    }
  });
}

function closeDetails(){
  document.getElementById('details-panel').classList.remove('open');
  document.getElementById('overlay').style.display = 'none';
}

map.on('click', ()=> { closeDetails(); });
</script>
</body>
</html>
